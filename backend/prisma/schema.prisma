// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                     @id @default(autoincrement())
  email                  String                  @unique
  name                   String?
  password               String
  role                   Role                    @default(TECHNICIAN)
  created_at             DateTime                @default(now())
  updated_at             DateTime                @updatedAt
  preventiveMaintenances PreventiveMaintenance[]
  workOrders             WorkOrder[]
  requests               Request[]

  @@map("users")
}

model Asset {
  id            Int       @id @default(autoincrement())
  name          String
  category_id   Int
  location      String?
  status        Status    @default(ACTIVE)
  purchase_date DateTime?
  description   String?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  category               AssetCategory           @relation(fields: [category_id], references: [id])
  preventiveMaintenances PreventiveMaintenance[]
  workOrders             WorkOrder[]
  requests               Request[]

  @@map("assets")
}

model AssetCategory {
  id   Int    @id @default(autoincrement())
  name String @unique

  assets Asset[]

  @@map("asset_categories")
}

model PreventiveMaintenance {
  id             Int      @id @default(autoincrement())
  title          String
  description    String
  frequency      String
  next_due_date  DateTime
  last_done_date DateTime
  assigned_to    Int?
  is_active      Status   @default(ACTIVE)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  asset_id   Int
  asset      Asset       @relation(fields: [asset_id], references: [id])
  user       User?       @relation(fields: [assigned_to], references: [id])
  workOrders WorkOrder[]

  @@map("preventive_maintenances")
}

model Request {
  id           Int           @id @default(autoincrement())
  title        String
  description  String?
  asset        Asset?        @relation(fields: [asset_id], references: [id])
  asset_id     Int?
  priority     Priority      @default(MEDIUM)
  status       RequestStatus @default(PENDING)
  requester    User          @relation(fields: [requester_id], references: [id])
  requester_id Int
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt

  workOrders WorkOrder?

  @@map("requests")
}

model WorkOrder {
  id          Int    @id @default(autoincrement())
  title       String
  description String

  // Work order can come from a request or a PM
  request        Request?               @relation(fields: [request_id], references: [id])
  request_id     Int?                   @unique
  pm_schedule    PreventiveMaintenance? @relation(fields: [pm_schedule_id], references: [id])
  pm_schedule_id Int?
  asset          Asset                  @relation(fields: [asset_id], references: [id])
  asset_id       Int
  assigned_to    User?                  @relation(fields: [assigned_to_id], references: [id])
  assigned_to_id Int?

  status         WorkStatus @default(OPEN)
  startDate      DateTime?
  completionDate DateTime?
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt

  @@map("work_orders")
}

enum Role {
  ADMIN
  SUPERVISOR
  TECHNICIAN
  REQUESTER
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum Status {
  ACTIVE
  DOWN
}

enum WorkStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}
